package core

import (
	"testing"

	"github.com/dbx123/go-battleships/core/types"
)

func TestCheckWinner(t *testing.T) {
	for name, tt := range map[string]struct {
		p      string
		winner int
		loser  int
	}{
		"collision bug": {
			p:      `{"gs":10,"sv":15,"gt":2,"p1":{"id":"FredDBX","sea":{"dim":10,"shp":[{"ds":1,"ps":[{"x":5,"y":5,"s":1}]},{"ds":2,"ps":[{"x":5,"y":1,"s":1},{"x":5,"y":2,"s":1}]},{"ds":3,"ps":[{"x":5,"y":7,"s":1},{"x":5,"y":8,"s":1},{"x":5,"y":9,"s":1}]},{"ds":4,"ps":[{"x":7,"y":1,"s":0},{"x":7,"y":2,"s":0},{"x":7,"y":3,"s":0},{"x":7,"y":4,"s":0}]},{"ds":5,"ps":[{"x":9,"y":4,"s":1},{"x":9,"y":5,"s":1},{"x":9,"y":6,"s":1},{"x":9,"y":7,"s":1},{"x":9,"y":8,"s":1}]}]},"sht":[{"x":1,"y":1,"s":0},{"x":1,"y":2,"s":0},{"x":1,"y":3,"s":0},{"x":1,"y":4,"s":0},{"x":2,"y":1,"s":0},{"x":2,"y":3,"s":0},{"x":6,"y":1,"s":0},{"x":6,"y":2,"s":0},{"x":6,"y":3,"s":0},{"x":7,"y":2,"s":0},{"x":5,"y":2,"s":0},{"x":4,"y":2,"s":0},{"x":3,"y":2,"s":0},{"x":2,"y":2,"s":0},{"x":10,"y":10,"s":0},{"x":9,"y":10,"s":0},{"x":10,"y":9,"s":0},{"x":9,"y":9,"s":0},{"x":9,"y":8,"s":0},{"x":8,"y":9,"s":0},{"x":8,"y":10,"s":0},{"x":5,"y":6,"s":0},{"x":2,"y":10,"s":0},{"x":4,"y":1,"s":0},{"x":8,"y":6,"s":0},{"x":3,"y":6,"s":0},{"x":10,"y":1,"s":0},{"x":9,"y":1,"s":0},{"x":9,"y":2,"s":0},{"x":9,"y":3,"s":0},{"x":9,"y":4,"s":0},{"x":9,"y":5,"s":0},{"x":9,"y":6,"s":0},{"x":8,"y":4,"s":0},{"x":7,"y":4,"s":0},{"x":6,"y":4,"s":0},{"x":5,"y":4,"s":0}],"rcv":[{"x":1,"y":1,"s":3},{"x":5,"y":5,"s":1},{"x":5,"y":4,"s":3},{"x":2,"y":1,"s":3},{"x":1,"y":5,"s":3},{"x":7,"y":5,"s":3},{"x":6,"y":5,"s":3},{"x":4,"y":5,"s":3},{"x":5,"y":6,"s":3},{"x":6,"y":4,"s":3},{"x":4,"y":4,"s":3},{"x":5,"y":1,"s":1},{"x":6,"y":1,"s":3},{"x":4,"y":1,"s":3},{"x":5,"y":2,"s":1},{"x":5,"y":3,"s":3},{"x":2,"y":2,"s":3},{"x":2,"y":3,"s":3},{"x":8,"y":2,"s":3},{"x":3,"y":4,"s":3},{"x":1,"y":7,"s":3},{"x":9,"y":8,"s":1},{"x":9,"y":7,"s":1},{"x":9,"y":6,"s":1},{"x":9,"y":5,"s":1},{"x":9,"y":4,"s":1},{"x":8,"y":8,"s":3},{"x":2,"y":8,"s":3},{"x":9,"y":9,"s":3},{"x":3,"y":8,"s":3},{"x":4,"y":8,"s":3},{"x":5,"y":8,"s":1},{"x":5,"y":7,"s":1},{"x":5,"y":9,"s":1},{"x":5,"y":10,"s":3},{"x":8,"y":1,"s":3},{"x":1,"y":2,"s":3}],"hit":[{"x":1,"y":1,"s":1},{"x":1,"y":2,"s":1},{"x":1,"y":3,"s":1},{"x":6,"y":2,"s":1},{"x":5,"y":2,"s":1},{"x":4,"y":2,"s":1},{"x":3,"y":2,"s":1},{"x":2,"y":2,"s":1},{"x":9,"y":9,"s":1},{"x":9,"y":3,"s":1},{"x":9,"y":4,"s":1},{"x":8,"y":4,"s":1},{"x":7,"y":4,"s":1},{"x":6,"y":4,"s":1}]},"p2":{"id":"DBX","sea":{"dim":10,"shp":[{"ds":1,"ps":[{"x":9,"y":9,"s":1}]},{"ds":2,"ps":[{"x":9,"y":3,"s":1},{"x":9,"y":4,"s":1}]},{"ds":3,"ps":[{"x":1,"y":1,"s":1},{"x":1,"y":2,"s":1},{"x":1,"y":3,"s":1}]},{"ds":4,"ps":[{"x":6,"y":4,"s":1},{"x":7,"y":4,"s":1},{"x":8,"y":4,"s":1},{"x":9,"y":4,"s":0}]},{"ds":5,"ps":[{"x":2,"y":2,"s":1},{"x":3,"y":2,"s":1},{"x":4,"y":2,"s":1},{"x":5,"y":2,"s":1},{"x":6,"y":2,"s":1}]}]},"sht":[{"x":1,"y":1,"s":0},{"x":5,"y":5,"s":0},{"x":5,"y":4,"s":0},{"x":2,"y":1,"s":0},{"x":1,"y":5,"s":0},{"x":7,"y":5,"s":0},{"x":6,"y":5,"s":0},{"x":4,"y":5,"s":0},{"x":5,"y":6,"s":0},{"x":6,"y":4,"s":0},{"x":4,"y":4,"s":0},{"x":5,"y":1,"s":0},{"x":6,"y":1,"s":0},{"x":4,"y":1,"s":0},{"x":5,"y":2,"s":0},{"x":5,"y":3,"s":0},{"x":2,"y":2,"s":0},{"x":2,"y":3,"s":0},{"x":8,"y":2,"s":0},{"x":3,"y":4,"s":0},{"x":1,"y":7,"s":0},{"x":9,"y":8,"s":0},{"x":9,"y":7,"s":0},{"x":9,"y":6,"s":0},{"x":9,"y":5,"s":0},{"x":9,"y":4,"s":0},{"x":8,"y":8,"s":0},{"x":2,"y":8,"s":0},{"x":9,"y":9,"s":0},{"x":3,"y":8,"s":0},{"x":4,"y":8,"s":0},{"x":5,"y":8,"s":0},{"x":5,"y":7,"s":0},{"x":5,"y":9,"s":0},{"x":5,"y":10,"s":0},{"x":8,"y":1,"s":0},{"x":1,"y":2,"s":0}],"rcv":[{"x":1,"y":1,"s":1},{"x":1,"y":2,"s":1},{"x":1,"y":3,"s":1},{"x":1,"y":4,"s":3},{"x":2,"y":1,"s":3},{"x":2,"y":3,"s":3},{"x":6,"y":1,"s":3},{"x":6,"y":2,"s":1},{"x":6,"y":3,"s":3},{"x":7,"y":2,"s":3},{"x":5,"y":2,"s":1},{"x":4,"y":2,"s":1},{"x":3,"y":2,"s":1},{"x":2,"y":2,"s":1},{"x":10,"y":10,"s":3},{"x":9,"y":10,"s":3},{"x":10,"y":9,"s":3},{"x":9,"y":9,"s":1},{"x":9,"y":8,"s":3},{"x":8,"y":9,"s":3},{"x":8,"y":10,"s":3},{"x":5,"y":6,"s":3},{"x":2,"y":10,"s":3},{"x":4,"y":1,"s":3},{"x":8,"y":6,"s":3},{"x":3,"y":6,"s":3},{"x":10,"y":1,"s":3},{"x":9,"y":1,"s":3},{"x":9,"y":2,"s":3},{"x":9,"y":3,"s":1},{"x":9,"y":4,"s":1},{"x":9,"y":5,"s":3},{"x":9,"y":6,"s":3},{"x":8,"y":4,"s":1},{"x":7,"y":4,"s":1},{"x":6,"y":4,"s":1},{"x":5,"y":4,"s":3}],"hit":[{"x":5,"y":5,"s":1},{"x":5,"y":1,"s":1},{"x":5,"y":2,"s":1},{"x":9,"y":8,"s":1},{"x":9,"y":7,"s":1},{"x":9,"y":6,"s":1},{"x":9,"y":5,"s":1},{"x":9,"y":4,"s":1},{"x":5,"y":8,"s":1},{"x":5,"y":7,"s":1},{"x":5,"y":9,"s":1}]}}`,
			winner: 0,
			loser:  0,
		},
		"1p bug": {
			p:      `{"gs":10,"sv":1,"gt":1,"p1":{"id":"CPU","sea":{"dim":10,"shp":[{"ds":0,"ps":null},{"ds":1,"ps":[{"x":10,"y":10,"s":0}]}]},"sht":[{"x":1,"y":1,"s":0},{"x":10,"y":10,"s":0}],"rcv":null,"hit":[{"x":10,"y":10,"s":1}]},"p2":{"id":"dbx","sea":{"dim":10,"shp":[{"ds":0,"ps":null},{"ds":1,"ps":[{"x":10,"y":10,"s":1}]}]},"sht":null,"rcv":[{"x":1,"y":1,"s":3},{"x":10,"y":10,"s":1}],"hit":null}}`,
			winner: 1,
			loser:  2,
		},
	} {
		t.Run(name, func(t *testing.T) {
			DecodeGame(tt.p)
			winner, loser := CheckWinner()

			if tt.winner != winner || tt.loser != loser {
				t.Fatalf("Expected `%v,%v` Got `%v,%v`", tt.winner, tt.loser, winner, loser)
			}
		})
	}
}

func TestCheckCollisions(t *testing.T) {
	for name, tt := range map[string]struct {
		p       string
		results []bool
	}{
		"collision bug": {
			p:       `{"gs":10,"sv":15,"gt":2,"p1":{"id":"FredDBX","sea":{"dim":10,"shp":[{"ds":1,"ps":[{"x":5,"y":5,"s":1}]},{"ds":2,"ps":[{"x":5,"y":1,"s":1},{"x":5,"y":2,"s":1}]},{"ds":3,"ps":[{"x":5,"y":7,"s":1},{"x":5,"y":8,"s":1},{"x":5,"y":9,"s":1}]},{"ds":4,"ps":[{"x":7,"y":1,"s":0},{"x":7,"y":2,"s":0},{"x":7,"y":3,"s":0},{"x":7,"y":4,"s":0}]},{"ds":5,"ps":[{"x":9,"y":4,"s":1},{"x":9,"y":5,"s":1},{"x":9,"y":6,"s":1},{"x":9,"y":7,"s":1},{"x":9,"y":8,"s":1}]}]},"sht":[{"x":1,"y":1,"s":0},{"x":1,"y":2,"s":0},{"x":1,"y":3,"s":0},{"x":1,"y":4,"s":0},{"x":2,"y":1,"s":0},{"x":2,"y":3,"s":0},{"x":6,"y":1,"s":0},{"x":6,"y":2,"s":0},{"x":6,"y":3,"s":0},{"x":7,"y":2,"s":0},{"x":5,"y":2,"s":0},{"x":4,"y":2,"s":0},{"x":3,"y":2,"s":0},{"x":2,"y":2,"s":0},{"x":10,"y":10,"s":0},{"x":9,"y":10,"s":0},{"x":10,"y":9,"s":0},{"x":9,"y":9,"s":0},{"x":9,"y":8,"s":0},{"x":8,"y":9,"s":0},{"x":8,"y":10,"s":0},{"x":5,"y":6,"s":0},{"x":2,"y":10,"s":0},{"x":4,"y":1,"s":0},{"x":8,"y":6,"s":0},{"x":3,"y":6,"s":0},{"x":10,"y":1,"s":0},{"x":9,"y":1,"s":0},{"x":9,"y":2,"s":0},{"x":9,"y":3,"s":0},{"x":9,"y":4,"s":0},{"x":9,"y":5,"s":0},{"x":9,"y":6,"s":0},{"x":8,"y":4,"s":0},{"x":7,"y":4,"s":0},{"x":6,"y":4,"s":0},{"x":5,"y":4,"s":0}],"rcv":[{"x":1,"y":1,"s":3},{"x":5,"y":5,"s":1},{"x":5,"y":4,"s":3},{"x":2,"y":1,"s":3},{"x":1,"y":5,"s":3},{"x":7,"y":5,"s":3},{"x":6,"y":5,"s":3},{"x":4,"y":5,"s":3},{"x":5,"y":6,"s":3},{"x":6,"y":4,"s":3},{"x":4,"y":4,"s":3},{"x":5,"y":1,"s":1},{"x":6,"y":1,"s":3},{"x":4,"y":1,"s":3},{"x":5,"y":2,"s":1},{"x":5,"y":3,"s":3},{"x":2,"y":2,"s":3},{"x":2,"y":3,"s":3},{"x":8,"y":2,"s":3},{"x":3,"y":4,"s":3},{"x":1,"y":7,"s":3},{"x":9,"y":8,"s":1},{"x":9,"y":7,"s":1},{"x":9,"y":6,"s":1},{"x":9,"y":5,"s":1},{"x":9,"y":4,"s":1},{"x":8,"y":8,"s":3},{"x":2,"y":8,"s":3},{"x":9,"y":9,"s":3},{"x":3,"y":8,"s":3},{"x":4,"y":8,"s":3},{"x":5,"y":8,"s":1},{"x":5,"y":7,"s":1},{"x":5,"y":9,"s":1},{"x":5,"y":10,"s":3},{"x":8,"y":1,"s":3},{"x":1,"y":2,"s":3}],"hit":[{"x":1,"y":1,"s":1},{"x":1,"y":2,"s":1},{"x":1,"y":3,"s":1},{"x":6,"y":2,"s":1},{"x":5,"y":2,"s":1},{"x":4,"y":2,"s":1},{"x":3,"y":2,"s":1},{"x":2,"y":2,"s":1},{"x":9,"y":9,"s":1},{"x":9,"y":3,"s":1},{"x":9,"y":4,"s":1},{"x":8,"y":4,"s":1},{"x":7,"y":4,"s":1},{"x":6,"y":4,"s":1}]},"p2":{"id":"DBX","sea":{"dim":10,"shp":[{"ds":1,"ps":[{"x":9,"y":9,"s":1}]},{"ds":2,"ps":[{"x":9,"y":3,"s":1},{"x":9,"y":4,"s":1}]},{"ds":3,"ps":[{"x":1,"y":1,"s":1},{"x":1,"y":2,"s":1},{"x":1,"y":3,"s":1}]},{"ds":4,"ps":[{"x":6,"y":4,"s":1},{"x":7,"y":4,"s":1},{"x":8,"y":4,"s":1},{"x":9,"y":4,"s":0}]},{"ds":5,"ps":[{"x":2,"y":2,"s":1},{"x":3,"y":2,"s":1},{"x":4,"y":2,"s":1},{"x":5,"y":2,"s":1},{"x":6,"y":2,"s":1}]}]},"sht":[{"x":1,"y":1,"s":0},{"x":5,"y":5,"s":0},{"x":5,"y":4,"s":0},{"x":2,"y":1,"s":0},{"x":1,"y":5,"s":0},{"x":7,"y":5,"s":0},{"x":6,"y":5,"s":0},{"x":4,"y":5,"s":0},{"x":5,"y":6,"s":0},{"x":6,"y":4,"s":0},{"x":4,"y":4,"s":0},{"x":5,"y":1,"s":0},{"x":6,"y":1,"s":0},{"x":4,"y":1,"s":0},{"x":5,"y":2,"s":0},{"x":5,"y":3,"s":0},{"x":2,"y":2,"s":0},{"x":2,"y":3,"s":0},{"x":8,"y":2,"s":0},{"x":3,"y":4,"s":0},{"x":1,"y":7,"s":0},{"x":9,"y":8,"s":0},{"x":9,"y":7,"s":0},{"x":9,"y":6,"s":0},{"x":9,"y":5,"s":0},{"x":9,"y":4,"s":0},{"x":8,"y":8,"s":0},{"x":2,"y":8,"s":0},{"x":9,"y":9,"s":0},{"x":3,"y":8,"s":0},{"x":4,"y":8,"s":0},{"x":5,"y":8,"s":0},{"x":5,"y":7,"s":0},{"x":5,"y":9,"s":0},{"x":5,"y":10,"s":0},{"x":8,"y":1,"s":0},{"x":1,"y":2,"s":0}],"rcv":[{"x":1,"y":1,"s":1},{"x":1,"y":2,"s":1},{"x":1,"y":3,"s":1},{"x":1,"y":4,"s":3},{"x":2,"y":1,"s":3},{"x":2,"y":3,"s":3},{"x":6,"y":1,"s":3},{"x":6,"y":2,"s":1},{"x":6,"y":3,"s":3},{"x":7,"y":2,"s":3},{"x":5,"y":2,"s":1},{"x":4,"y":2,"s":1},{"x":3,"y":2,"s":1},{"x":2,"y":2,"s":1},{"x":10,"y":10,"s":3},{"x":9,"y":10,"s":3},{"x":10,"y":9,"s":3},{"x":9,"y":9,"s":1},{"x":9,"y":8,"s":3},{"x":8,"y":9,"s":3},{"x":8,"y":10,"s":3},{"x":5,"y":6,"s":3},{"x":2,"y":10,"s":3},{"x":4,"y":1,"s":3},{"x":8,"y":6,"s":3},{"x":3,"y":6,"s":3},{"x":10,"y":1,"s":3},{"x":9,"y":1,"s":3},{"x":9,"y":2,"s":3},{"x":9,"y":3,"s":1},{"x":9,"y":4,"s":1},{"x":9,"y":5,"s":3},{"x":9,"y":6,"s":3},{"x":8,"y":4,"s":1},{"x":7,"y":4,"s":1},{"x":6,"y":4,"s":1},{"x":5,"y":4,"s":3}],"hit":[{"x":5,"y":5,"s":1},{"x":5,"y":1,"s":1},{"x":5,"y":2,"s":1},{"x":9,"y":8,"s":1},{"x":9,"y":7,"s":1},{"x":9,"y":6,"s":1},{"x":9,"y":5,"s":1},{"x":9,"y":4,"s":1},{"x":5,"y":8,"s":1},{"x":5,"y":7,"s":1},{"x":5,"y":9,"s":1}]}}`,
			results: []bool{false, false, false, true, false},
		},
	} {
		t.Run(name, func(t *testing.T) {
			DecodeGame(tt.p)

			b := []types.Ship{}
			for k, a := range g.SecondPlayer.Sea.Ships {
				actual := CheckCollisions(&g.SecondPlayer.Sea.Ships[k], b)

				if tt.results[k] != actual {
					t.Fatalf("Expected `%v` Got `%v` (%v) adding [%v] to [%v]", tt.results[k], actual, k, a, b)
				}

				b = append(b, a)
			}
		})
	}
}
